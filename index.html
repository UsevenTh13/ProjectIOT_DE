<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Air Quality Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="frontend/css/dashboard.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-success text-white">
  <div class="container">
    <h1 class="mb-4">IoT Air Quality Dashboard</h1>
    <div id="status" class="status-text">Udara Baik</div>
    <button class="btn btn-light mt-4" onclick="toggleLog()">Lihat Log</button>

    <!-- Grafik Tren PPM -->
    <div class="mt-4">
      <h3>Grafik Tren PPM</h3>
      <canvas id="ppmChart" width="400" height="200"></canvas>
    </div>

    <!-- Tabel Log -->
    <div id="logTable" class="table-responsive">
      <table class="table table-bordered table-striped table-hover mt-3">
        <thead class="table-dark">
          <tr>
            <th>Waktu</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <!-- log akan ditambahkan di sini -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Suara alarm -->
  <audio id="alarmSound" src="https://www.soundjay.com/buttons/beep-07.wav"></audio>

  <script>
    const CHANNEL_ID = "3096899"; 
    const READ_API_KEY = ""; 
    let URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=20`;
    if (READ_API_KEY) {
      URL += `&api_key=${READ_API_KEY}`;
    }

    let ppmChart;

    async function updateStatus() {
      try {
        let response = await fetch(URL);
        let data = await response.json();
        let feeds = data.feeds;

        if (!feeds.length) return;

        let latest = feeds[feeds.length - 1];
        let ppm = latest.field1;
        let kategoriVal = parseInt(latest.field2);
        let waktu = new Date(latest.created_at).toLocaleTimeString();

        const body = document.body;
        const statusText = document.getElementById('status');
        const alarm = document.getElementById('alarmSound');
        const logBody = document.getElementById('logBody');

        let kategoriTxt = "Baik";
        if (kategoriVal === 1) kategoriTxt = "Baik";
        else if (kategoriVal === 2) kategoriTxt = "Sedang";
        else if (kategoriVal === 3) kategoriTxt = "Tidak Sehat";
        else kategoriTxt = "Berbahaya";

        if (kategoriVal <= 1) {
          body.className = "bg-success text-white";
          statusText.innerHTML = `Udara ${kategoriTxt} (PPM: ${ppm})`;
          statusText.classList.remove("blink");
        } else {
          body.className = "bg-danger text-white";
          statusText.innerHTML = `Udara ${kategoriTxt} (PPM: ${ppm})`;
          statusText.classList.add("blink");
          alarm.play();
        }

        // Tambahkan log baru
        let row = `<tr><td>${waktu}</td><td>${kategoriTxt} (PPM: ${ppm})</td></tr>`;
        logBody.innerHTML = row + logBody.innerHTML;

        // Update chart
        renderChart(feeds);

      } catch (err) {
        console.error("Gagal fetch dari ThingSpeak:", err);
      }
    }

    function renderChart(feeds) {
      let labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
      let ppmData = feeds.map(f => f.field1);

      let ctx = document.getElementById('ppmChart').getContext('2d');
      
      if (ppmChart) {
        ppmChart.data.labels = labels;
        ppmChart.data.datasets[0].data = ppmData;
        ppmChart.update();
      } else {
        ppmChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'PPM',
              data: ppmData,
              borderColor: 'rgba(0, 255, 0, 1)',
              backgroundColor: 'rgba(0, 255, 0, 0.2)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
              x: { ticks: { color: 'white' } },
              y: { ticks: { color: 'white' } }
            }
          }
        });
      }
    }

    function toggleLog() {
      const logTable = document.getElementById('logTable');
      logTable.style.display = (logTable.style.display === "none") ? "block" : "none";
    }

    updateStatus();
    setInterval(updateStatus, 20000);
  </script>
</body>
</html>